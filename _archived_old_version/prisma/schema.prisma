generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model WorkflowRun {
  id                    String    @id @default(auto()) @map("_id") @db.ObjectId
  topic                 String
  status                WorkflowStatus @default(INITIALIZING)
  currentCycle          Int       @default(1)
  maxCycles             Int       @default(3)
  qualityThreshold      Float     @default(7.0)
  finalQualityScore     Float?
  humanReviewRequired   Boolean   @default(false)
  humanReviewProvided   Boolean   @default(false)
  humanReviewFeedback   String?
  agentStatus           Json?
  startedAt             DateTime  @default(now())
  completedAt           DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  contentVersions       ContentVersion[]
  agentResponses        AgentResponse[]
  humanReviews          HumanReview[]
  reviewQueue           ReviewQueue?

  @@map("workflow_runs")
}

model ContentVersion {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  workflowRunId String    @db.ObjectId
  cycleNumber   Int
  versionType   VersionType
  content       Json
  imageUrl      String?
  metadata      Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  workflowRun   WorkflowRun @relation(fields: [workflowRunId], references: [id], onDelete: Cascade)

  @@map("content_versions")
  @@unique([workflowRunId, cycleNumber], name: "workflowRunId_cycleNumber")
}

model AgentResponse {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  workflowRunId String    @db.ObjectId
  agentType     AgentType
  cycleNumber   Int
  input         Json?
  output        Json
  success       Boolean   @default(true)
  errorMessage  String?
  executionTime Int?
  tokensUsed    Int?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  workflowRun   WorkflowRun @relation(fields: [workflowRunId], references: [id], onDelete: Cascade)

  @@map("agent_responses")
}

model HumanReview {
  id                    String    @id @default(auto()) @map("_id") @db.ObjectId
  workflowRunId         String    @db.ObjectId
  reviewerId            String?
  reviewerName          String?
  status                HumanReviewStatus @default(PENDING)
  priority              ReviewPriority @default(MEDIUM)
  triggerReason         TriggerReason
  action                ReviewAction?
  feedback              String?
  customEdits           Json?
  qualityRating         Int?
  feedbackCategories    Json?
  reviewStartTime       DateTime?
  reviewCompletionTime  DateTime?
  estimatedReviewTime   Int?
  timeSpent             Int?
  dueDate               DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  workflowRun           WorkflowRun @relation(fields: [workflowRunId], references: [id], onDelete: Cascade)
  reviewComments        ReviewComment[]

  @@map("human_reviews")
  @@unique([workflowRunId])
}

model ReviewComment {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  humanReviewId String    @db.ObjectId
  contentType   CommentContentType
  text          String
  selection     Json?
  type          CommentType
  author        String
  timestamp     DateTime  @default(now())
  resolved      Boolean   @default(false)
  parentId      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  humanReview   HumanReview @relation(fields: [humanReviewId], references: [id], onDelete: Cascade)

  @@map("review_comments")
}

model ReviewMetrics {
  id                      String    @id @default(auto()) @map("_id") @db.ObjectId
  reviewerId              String
  reviewerName            String
  totalReviews            Int       @default(0)
  averageReviewTime       Float     @default(0)
  averageQualityImprovement Float   @default(0)
  decisionBreakdown       Json?
  categoryBreakdown       Json?
  lastReviewDate          DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  @@unique([reviewerId])
  @@map("review_metrics")
}

model ReviewQueue {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  workflowRunId   String    @db.ObjectId
  topic           String
  priority        ReviewPriority
  triggerReason   TriggerReason
  currentCycle    Int
  maxCycles       Int
  qualityScore    Float
  estimatedReviewTime Int?
  assignedTo      String?
  timeInQueue     Int       @default(0)
  dueDate         DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  workflowRun     WorkflowRun @relation(fields: [workflowRunId], references: [id], onDelete: Cascade)

  @@map("review_queue")
  @@unique([workflowRunId])
}

enum WorkflowStatus {
  INITIALIZING
  RUNNING
  CONTENT_GENERATION
  WEB_SEARCH_CRITIC
  QUALITY_CRITIC
  HUMAN_REVIEW
  COMPLETED
  FAILED
  CANCELLED
}

enum VersionType {
  INITIAL
  IMPROVED
  FINAL
}

enum AgentType {
  CONTENT_GENERATOR
  WEB_SEARCH_CRITIC
  QUALITY_CRITIC
  WORKFLOW_MANAGER
}

enum HumanReviewStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  ESCALATED
  EXPIRED
}

enum ReviewPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TriggerReason {
  QUALITY_THRESHOLD_NOT_MET
  MAX_CYCLES_REACHED
  ACCURACY_CONCERNS
  USER_REQUESTED
  ESCALATION
}

enum ReviewAction {
  ACCEPT
  IMPROVE
  REJECT
}

enum CommentType {
  SUGGESTION
  QUESTION
  ISSUE
  PRAISE
}

enum CommentContentType {
  definition
  linkedinPost
  imagePrompt
}
