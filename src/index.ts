import express from 'express'; import cors from 'cors'; import helmet from 'helmet'; import { PrismaClient } from '@prisma/client'; import dotenv from 'dotenv';  import workflowsRouter from './routes/workflows'; import logger from './utils/logger';  // Load environment variables dotenv.config();  const app = express(); const PORT = process.env.PORT || 3001;  // Initialize Prisma client const prisma = new PrismaClient();  // Security middleware app.use(helmet());  // CORS middleware app.use(cors({   origin: process.env.CORS_ORIGIN || '*',   methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],   allowedHeaders: ['Content-Type', 'Authorization'], }));  // Body parsing middleware app.use(express.json({ limit: '10mb' })); app.use(express.urlencoded({ extended: true, limit: '10mb' }));  // Request logging middleware app.use((req, res, next) => {   logger.info('Incoming request', {     method: req.method,     url: req.url,     ip: req.ip,     userAgent: req.get('User-Agent'),   });   next(); });  // API routes app.use('/api/workflows', workflowsRouter);  // Health check endpoint app.get('/health', (req, res) => {   res.json({     status: 'healthy',     timestamp: new Date().toISOString(),     uptime: process.uptime(),     environment: process.env.NODE_ENV || 'development',   }); });  // Root endpoint app.get('/', (req, res) => {   res.json({     message: 'Agentic App API Server',     version: '1.0.0',     endpoints: {       health: '/health',       workflows: {         start: 'POST /api/workflows/start',         get: 'GET /api/workflows/:id',         list: 'GET /api/workflows',         humanReview: 'POST /api/workflows/:id/human-review',         versions: 'GET /api/workflows/:id/versions',         delete: 'DELETE /api/workflows/:id',       },     },   }); });  // 404 handler app.use('*', (req, res) => {   res.status(404).json({     success: false,     error: 'Endpoint not found',     availableEndpoints: {       health: '/health',       workflows: '/api/workflows/*',     },   }); });  // Global error handler app.use((error: Error, req: express.Request, res: express.Response, next: express.NextFunction) => {   logger.error('Unhandled error', {     error: error.message,     stack: error.stack,     method: req.method,     url: req.url,   });    res.status(500).json({     success: false,     error: 'Internal server error',     message: process.env.NODE_ENV === 'development' ? error.message : undefined,   }); });  // Graceful shutdown process.on('SIGTERM', async () => {   logger.info('SIGTERM received, shutting down gracefully');    // Close database connection   await prisma.$disconnect();    // Close server   process.exit(0); });  process.on('SIGINT', async () => {   logger.info('SIGINT received, shutting down gracefully');    // Close database connection   await prisma.$disconnect();    // Close server   process.exit(0); });  // Start server const startServer = async () => {   try {     // Test database connection     await prisma.$connect();     logger.info('Database connected successfully');      app.listen(PORT, () => {       logger.info(`Server started successfully`, {         port: PORT,         environment: process.env.NODE_ENV || 'development',         nodeVersion: process.version,       });     });   } catch (error) {     logger.error('Failed to start server', {       error: (error as Error).message,       stack: (error as Error).stack,     });     process.exit(1);   } };  // Handle uncaught exceptions process.on('uncaughtException', (error) => {   logger.error('Uncaught exception', {     error: error.message,     stack: error.stack,   });   process.exit(1); });  // Handle unhandled promise rejections process.on('unhandledRejection', (reason, promise) => {   logger.error('Unhandled promise rejection', {     reason,     promise,   });   process.exit(1); });  startServer();  export default app; 